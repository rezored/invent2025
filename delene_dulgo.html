<!doctype html>
<html lang="bg">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Писмено деление</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Моноширинен изглед за математиката */
        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Хоризонтална линия като при писмено деление */
        .bar {
            border-top: 2px solid #111827;
        }

        /* slate-900 */
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <div class="max-w-3xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-start justify-between gap-4 flex-wrap">
                <div>
                    <h1 class="text-2xl font-semibold">Писмено деление</h1>
                    <p class="text-slate-600 mt-1">Показва стъпка по стъпка делението до край или период.</p>
                </div>

                <div class="flex gap-2">
                    <button id="exampleBtn" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-900">
                        Пример 22 : 7
                    </button>
                    <button id="clearBtn" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-900">
                        Изчисти
                    </button>
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-[1fr_auto_1fr_auto] gap-3 items-end">
                <div>
                    <label class="block text-sm font-medium text-slate-700">Делимо</label>
                    <input id="a" type="number" value="22"
                        class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 mono" />
                </div>

                <div class="text-center text-xl mono pb-2">:</div>

                <div>
                    <label class="block text-sm font-medium text-slate-700">Делител</label>
                    <input id="b" type="number" value="7"
                        class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-400 mono" />
                </div>

                <div class="sm:pt-6">
                    <button id="goBtn"
                        class="w-full px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 active:bg-slate-950">
                        Покажи
                    </button>
                </div>
            </div>

            <div id="error" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 text-red-800 p-3"></div>

            <div class="mt-6">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <div class="text-sm text-slate-600">
                        Съвет: за периодични дроби ще видиш периода в скоби, напр. <span class="mono">0,(3)</span>.
                    </div>
                    <div class="text-sm text-slate-600">
                        Лимит стъпки:
                        <select id="limit" class="ml-2 rounded-lg border border-slate-300 px-2 py-1 bg-white">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="resultWrap" class="mt-6 hidden">
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                    <div class="text-sm text-slate-600">Резултат</div>
                    <div id="quotient" class="mono text-xl font-semibold mt-1"></div>
                </div>

                <div class="mt-6">
                    <div class="text-sm text-slate-600 mb-2">Стъпки</div>
                    <div id="steps" class="mono text-base leading-6"></div>
                </div>
            </div>
        </div>

        <div class="text-xs text-slate-500 mt-4">
            Бележка: използва се запетая за десетична част (BG), както в училище.
        </div>
    </div>

    <script>
        function showError(msg) {
            const el = document.getElementById("error");
            el.textContent = msg;
            el.classList.remove("hidden");
        }
        function hideError() {
            document.getElementById("error").classList.add("hidden");
        }

        // Връща:
        // - quotientString (с период в скоби при нужда)
        // - blocks: масив от "блокове" за визуализация (минuенд, product, remainder, indent)
        function computeLongDivision(aRaw, bRaw, maxSteps) {
            if (!Number.isFinite(aRaw) || !Number.isFinite(bRaw)) {
                throw new Error("Моля, въведи валидни числа.");
            }
            if (bRaw === 0) throw new Error("Деление на 0 не е позволено.");

            let a = Math.trunc(aRaw);
            let b = Math.trunc(bRaw);

            const sign = (a < 0) ^ (b < 0) ? "-" : "";
            a = Math.abs(a);
            b = Math.abs(b);

            const integerPart = Math.floor(a / b);
            let remainder = a % b;

            const blocks = [];
            blocks.push({
                minuend: a,
                sub: integerPart * b,
                rem: remainder,
                indent: 0,
                hideSub: integerPart === 0
            });

            const decimals = [];
            const seenRemainders = new Map();
            let periodStart = -1;
            let step = 0;

            while (remainder !== 0 && step < maxSteps) {
                if (seenRemainders.has(remainder)) {
                    periodStart = seenRemainders.get(remainder);
                    break;
                }
                seenRemainders.set(remainder, decimals.length);

                const next = remainder * 10;
                const digit = Math.floor(next / b);
                const sub = digit * b;
                const newRem = next - sub;

                decimals.push(String(digit));
                blocks.push({
                    minuend: next,
                    sub: sub,
                    rem: newRem,
                    indent: step + 1
                });

                remainder = newRem;
                step++;
            }

            let q = sign + String(integerPart);
            if (decimals.length > 0 || remainder !== 0) {
                q += ",";
                if (periodStart >= 0) {
                    const nonPeriod = decimals.slice(0, periodStart).join("");
                    const period = decimals.slice(periodStart).join("");
                    q += nonPeriod + "(" + period + ")";
                } else {
                    q += decimals.join("");
                }
            }

            const hitLimit = remainder !== 0 && periodStart < 0 && step >= maxSteps;
            if (hitLimit) q += "...";

            return { quotientString: q, blocks, periodStart, hitLimit };
        }

        function renderBlocks(blocks) {
            const lines = [];
            for (let i = 0; i < blocks.length; i++) {
                const blk = blocks[i];
                const indent = blk.indent;
                const minuendStr = String(blk.minuend);
                const subStr = String(blk.sub);
                const remStr = String(blk.rem);

                // A) Minuend
                lines.push(`<div class="flex">` +
                    `<span class="inline-block" style="width:${indent}ch"></span>` +
                    `<span>${escapeHtml(minuendStr)}</span>` +
                    `</div>`);

                if (!blk.hideSub) {
                    // B) Subtraction
                    const padding = Math.max(0, minuendStr.length - subStr.length);
                    lines.push(`<div class="flex text-slate-600 relative">` +
                        `<span class="inline-block" style="width:${indent}ch">` +
                        `<span class="absolute" style="transform: translateX(-1.5ch)">-</span>` +
                        `</span>` +
                        `<span class="inline-block" style="width:${padding}ch"></span>` +
                        `<span>${escapeHtml(subStr)}</span>` +
                        `</div>`);

                    // C) Bar
                    const barWidth = Math.max(minuendStr.length, subStr.length);
                    lines.push(`<div class="flex">` +
                        `<span class="inline-block" style="width:${indent}ch"></span>` +
                        `<div class="bar" style="width:${barWidth}ch"></div>` +
                        `</div>`);

                    // D) Remainder
                    const remPadding = Math.max(0, minuendStr.length - remStr.length);
                    lines.push(`<div class="flex">` +
                        `<span class="inline-block" style="width:${indent + remPadding}ch"></span>` +
                        `<span>${escapeHtml(remStr)}</span>` +
                        `</div>`);
                } else {
                    // Placeholder bar for initial step if needed
                    const barWidth = minuendStr.length;
                    lines.push(`<div class="flex">` +
                        `<span class="inline-block" style="width:${indent}ch"></span>` +
                        `<div class="bar" style="width:${barWidth}ch"></div>` +
                        `</div>`);
                    lines.push(`<div class="flex">` +
                        `<span class="inline-block" style="width:${indent}ch"></span>` +
                        `<span>${escapeHtml(remStr)}</span>` +
                        `</div>`);
                }
                lines.push(`<div class="h-3"></div>`);
            }
            return lines.join("");
        }

        function escapeHtml(str) {
            return str
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;");
        }

        function run() {
            hideError();
            const a = Number(document.getElementById("a").value);
            const b = Number(document.getElementById("b").value);
            const maxSteps = Number(document.getElementById("limit").value);

            try {
                const { quotientString, blocks, hitLimit } = computeLongDivision(a, b, maxSteps);

                document.getElementById("resultWrap").classList.remove("hidden");
                document.getElementById("quotient").textContent = quotientString;

                const stepsEl = document.getElementById("steps");
                stepsEl.innerHTML = renderBlocks(blocks);

                if (hitLimit) {
                    stepsEl.insertAdjacentHTML("beforeend",
                        `<div class="text-slate-600 text-sm mt-2">
            ⚠️ Достигнат е лимитът от ${maxSteps} стъпки. Увеличи лимита, ако искаш.
          </div>`
                    );
                }
            } catch (e) {
                document.getElementById("resultWrap").classList.add("hidden");
                showError(e.message || "Грешка.");
            }
        }

        document.getElementById("goBtn").addEventListener("click", run);
        document.getElementById("exampleBtn").addEventListener("click", () => {
            document.getElementById("a").value = 22;
            document.getElementById("b").value = 7;
            run();
        });
        document.getElementById("clearBtn").addEventListener("click", () => {
            document.getElementById("a").value = "";
            document.getElementById("b").value = "";
            document.getElementById("resultWrap").classList.add("hidden");
            hideError();
        });

        // Enter за удобство
        ["a", "b"].forEach(id => {
            document.getElementById(id).addEventListener("keydown", (e) => {
                if (e.key === "Enter") run();
            });
        });

        // initial render
        run();
    </script>
</body>

</html>