---
import Layout from "../../layouts/Layout.astro";
import HeaderMain from "../../components/HeaderMain.astro";

const lang = "bg";
const pageTitle = "Playground | Писмено деление";
---

<Layout title={pageTitle} lang={lang}>
    <HeaderMain slot="header" />

    <main
        class="flex-1 max-w-4xl mx-auto w-full py-12 px-4 shadow-2xl relative z-10"
    >
        <div class="mb-8 border-b border-border-dark pb-6">
            <h1
                class="text-4xl font-bold mb-2 tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent"
            >
                Писмено деление
            </h1>
            <p class="text-slate-400 text-lg leading-relaxed">
                Показва стъпка по стъпка делението до край или период.
            </p>
        </div>

        <div
            class="bg-surface-dark border border-border-dark p-6 md:p-10 rounded-3xl shadow-2xl relative overflow-hidden group"
        >
            <div class="scanline"></div>

            <!-- Controls -->
            <div class="flex flex-wrap items-end gap-6 mb-10 relative z-10">
                <div class="flex-1 min-w-[120px]">
                    <label
                        class="block text-xs font-mono uppercase text-slate-500 mb-2 tracking-widest"
                        >Делимо</label
                    >
                    <input
                        id="a"
                        type="number"
                        value="22"
                        class="w-full bg-background-dark/50 border border-border-dark rounded-xl px-4 py-3 text-white text-xl font-mono focus:border-primary focus:ring-1 focus:ring-primary/30 outline-none transition-all"
                    />
                </div>

                <div class="text-center text-2xl font-mono pb-3 text-slate-500">
                    :
                </div>

                <div class="flex-1 min-w-[120px]">
                    <label
                        class="block text-xs font-mono uppercase text-slate-500 mb-2 tracking-widest"
                        >Делител</label
                    >
                    <input
                        id="b"
                        type="number"
                        value="7"
                        class="w-full bg-background-dark/50 border border-border-dark rounded-xl px-4 py-3 text-white text-xl font-mono focus:border-primary focus:ring-1 focus:ring-primary/30 outline-none transition-all"
                    />
                </div>

                <div class="flex gap-3">
                    <button
                        id="goBtn"
                        class="px-8 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/80 active:scale-95 transition-all shadow-lg shadow-primary/20 h-[52px]"
                    >
                        Покажи
                    </button>
                    <button
                        id="clearBtn"
                        class="px-4 py-3 bg-slate-800 text-slate-300 font-bold rounded-xl hover:bg-slate-700 active:scale-95 transition-all h-[52px]"
                        title="Изчисти"
                    >
                        <span class="material-symbols-outlined">backspace</span>
                    </button>
                </div>
            </div>

            <!-- Settings -->
            <div
                class="flex flex-wrap items-center justify-between gap-4 mb-8 bg-black/20 p-4 rounded-2xl relative z-10"
            >
                <div class="flex items-center gap-3">
                    <button
                        id="exampleBtn"
                        class="text-xs font-bold text-primary hover:text-white transition-colors bg-primary/10 px-3 py-1.5 rounded-lg border border-primary/20"
                    >
                        Пример 22 : 7
                    </button>
                </div>
                <div
                    class="flex items-center gap-4 text-xs text-slate-500 font-mono"
                >
                    <span class="uppercase tracking-wider">Макс стъпки:</span>
                    <select
                        id="limit"
                        class="bg-slate-800 border border-slate-700 text-slate-300 rounded-lg px-2 py-1 outline-none cursor-pointer focus:border-primary"
                    >
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>

            <div
                id="error"
                class="hidden mb-6 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400 p-4 font-medium relative z-10"
            >
            </div>

            <div
                id="resultWrap"
                class="hidden relative z-10 animate-in fade-in slide-in-from-bottom-4 duration-500"
            >
                <div
                    class="rounded-2xl bg-primary/5 border border-primary/10 p-6 mb-8"
                >
                    <div
                        class="text-xs font-mono uppercase text-primary mb-2 tracking-widest"
                    >
                        Частно (Резултат)
                    </div>
                    <div
                        id="quotient"
                        class="font-mono text-3xl md:text-4xl font-bold text-white break-all"
                    >
                    </div>
                </div>

                <div>
                    <div
                        class="text-xs font-mono uppercase text-slate-500 mb-4 tracking-widest"
                    >
                        Визуализация
                    </div>
                    <div
                        id="steps"
                        class="font-mono text-lg md:text-xl leading-relaxed overflow-x-auto whitespace-pre p-8 bg-black/40 rounded-3xl border border-white/5 shadow-inner"
                    >
                    </div>
                </div>
            </div>

            <div
                class="mt-8 text-[10px] font-mono uppercase tracking-tighter text-slate-600 border-t border-border-dark pt-4 relative z-10 flex justify-between items-center"
            >
                <span>School Style Visualization Engine v1.1</span>
                <span>Bulgarian Educational Standard</span>
            </div>
        </div>

        <div class="mt-6 flex items-center gap-2 text-slate-500 text-sm">
            <span class="material-symbols-outlined text-sm">info</span>
            <span>За десетична част се използва запетая <b>(,)</b>.</span>
        </div>
    </main>

    <script is:inline>
        function showError(msg) {
            const el = document.getElementById("error");
            el.textContent = msg;
            el.classList.remove("hidden");
        }
        function hideError() {
            document.getElementById("error").classList.add("hidden");
        }

        function computeLongDivision(aRaw, bRaw, maxSteps) {
            if (!Number.isFinite(aRaw) || !Number.isFinite(bRaw)) {
                throw new Error("Моля, въведи валидни числа.");
            }
            if (bRaw === 0) throw new Error("Деление на 0 не е позволено.");

            let a = Math.trunc(aRaw);
            let b = Math.trunc(bRaw);

            const sign = (a < 0) ^ (b < 0) ? "-" : "";
            a = Math.abs(a);
            b = Math.abs(b);

            const integerPart = Math.floor(a / b);
            let remainder = a % b;

            const blocks = [];
            blocks.push({
                minuend: a,
                sub: integerPart * b,
                rem: remainder,
                indent: 0,
                hideSub: integerPart === 0 && a !== 0,
            });

            const decimals = [];
            const seenRemainders = new Map();
            let periodStart = -1;
            let step = 0;

            while (remainder !== 0 && step < maxSteps) {
                if (seenRemainders.has(remainder)) {
                    periodStart = seenRemainders.get(remainder);
                    break;
                }
                seenRemainders.set(remainder, decimals.length);

                const next = remainder * 10;
                const digit = Math.floor(next / b);
                const sub = digit * b;
                const newRem = next - sub;

                decimals.push(String(digit));
                blocks.push({
                    minuend: next,
                    sub: sub,
                    rem: newRem,
                    indent: step + String(integerPart).length + 1, // Offset by integer part length + comma
                });

                remainder = newRem;
                step++;
            }

            // Adjust indentation for steps - initial block indent is 0
            // Subsequent blocks should align under the dividend/remainders
            // In Bulgarian school math, we align under the last digit of the previous remainder/dividend multiplied by 10

            let q = sign + String(integerPart);
            if (decimals.length > 0) {
                q += ",";
                if (periodStart >= 0) {
                    const nonPeriod = decimals.slice(0, periodStart).join("");
                    const period = decimals.slice(periodStart).join("");
                    q += nonPeriod + "(" + period + ")";
                } else {
                    q += decimals.join("");
                }
            } else if (remainder !== 0) {
                q += ",";
            }

            const hitLimit =
                remainder !== 0 && periodStart < 0 && step >= maxSteps;
            if (hitLimit) q += "...";

            return { quotientString: q, blocks, periodStart, hitLimit };
        }

        function renderBlocks(blocks) {
            const lines = [];
            for (let i = 0; i < blocks.length; i++) {
                const blk = blocks[i];
                const indent = i === 0 ? 0 : i; // Simple increment for step visualization
                const minuendStr = String(blk.minuend);
                const subStr = String(blk.sub);
                const remStr = String(blk.rem);

                // A) Minuend
                lines.push(
                    `<div class="flex">` +
                        `<span class="inline-block" style="width:${indent}ch"></span>` +
                        `<span>${escapeHtml(minuendStr)}</span>` +
                        `</div>`,
                );

                if (!blk.hideSub) {
                    // B) Subtraction
                    const padding = Math.max(
                        0,
                        minuendStr.length - subStr.length,
                    );
                    lines.push(
                        `<div class="flex text-slate-400 relative">` +
                            `<span class="inline-block" style="width:${indent}ch">` +
                            `<span class="absolute" style="transform: translateX(-1.5ch)">-</span>` +
                            `</span>` +
                            `<span class="inline-block" style="width:${padding}ch"></span>` +
                            `<span>${escapeHtml(subStr)}</span>` +
                            `</div>`,
                    );

                    // C) Bar
                    const barWidth = Math.max(minuendStr.length, subStr.length);
                    lines.push(
                        `<div class="flex">` +
                            `<span class="inline-block" style="width:${indent}ch"></span>` +
                            `<div class="border-t-2 border-slate-500" style="width:${barWidth}ch"></div>` +
                            `</div>`,
                    );

                    // D) Remainder
                    const remPadding = Math.max(
                        0,
                        minuendStr.length - remStr.length,
                    );
                    lines.push(
                        `<div class="flex text-primary">` +
                            `<span class="inline-block" style="width:${indent + remPadding}ch"></span>` +
                            `<span>${escapeHtml(remStr)}</span>` +
                            `</div>`,
                    );
                } else {
                    // Placeholder bar for initial step if needed
                    const barWidth = minuendStr.length;
                    lines.push(
                        `<div class="flex">` +
                            `<span class="inline-block" style="width:${indent}ch"></span>` +
                            `<div class="border-t-2 border-slate-500" style="width:${barWidth}ch"></div>` +
                            `</div>`,
                    );
                    lines.push(
                        `<div class="flex text-primary">` +
                            `<span class="inline-block" style="width:${indent}ch"></span>` +
                            `<span>${escapeHtml(remStr)}</span>` +
                            `</div>`,
                    );
                }
                lines.push(`<div class="h-3"></div>`);
            }
            return lines.join("");
        }

        function escapeHtml(str) {
            return str
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;");
        }

        function run() {
            hideError();
            const a = Number(document.getElementById("a").value);
            const b = Number(document.getElementById("b").value);
            const maxSteps = Number(document.getElementById("limit").value);

            try {
                const { quotientString, blocks, hitLimit } =
                    computeLongDivision(a, b, maxSteps);

                const wrap = document.getElementById("resultWrap");
                wrap.classList.remove("hidden");

                document.getElementById("quotient").textContent =
                    quotientString;

                const stepsEl = document.getElementById("steps");
                stepsEl.innerHTML = renderBlocks(blocks);

                if (hitLimit) {
                    stepsEl.insertAdjacentHTML(
                        "beforeend",
                        `<div class="text-amber-400 text-sm mt-4 p-3 bg-amber-400/10 border border-amber-400/20 rounded-xl">
                            ⚠️ Достигнат е лимитът от ${maxSteps} стъпки. Увеличи лимита, ако искаш.
                         </div>`,
                    );
                }
            } catch (e) {
                document.getElementById("resultWrap").classList.add("hidden");
                showError(e.message || "Грешка.");
            }
        }

        const goBtn = document.getElementById("goBtn");
        const clearBtn = document.getElementById("clearBtn");
        const exampleBtn = document.getElementById("exampleBtn");

        goBtn.addEventListener("click", run);

        exampleBtn.addEventListener("click", () => {
            document.getElementById("a").value = 22;
            document.getElementById("b").value = 7;
            run();
        });

        clearBtn.addEventListener("click", () => {
            document.getElementById("a").value = "";
            document.getElementById("b").value = "";
            document.getElementById("resultWrap").classList.add("hidden");
            hideError();
        });

        ["a", "b"].forEach((id) => {
            document.getElementById(id).addEventListener("keydown", (e) => {
                if (e.key === "Enter") run();
            });
        });

        // initial render
        run();
    </script>
</Layout>

<style>
    #steps::-webkit-scrollbar {
        height: 8px;
    }
    #steps::-webkit-scrollbar-track {
        background: transparent;
    }
    #steps::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    #steps::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .animate-in {
        animation-fill-mode: forwards;
    }
</style>
